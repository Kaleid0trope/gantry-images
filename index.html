import React, { useState, useMemo, useEffect } from 'react';
import { MapPin, List, Plus, Home, Package, CheckCircle, Clock, AlertCircle, Filter, Search, ArrowLeft, Camera, FileText, Wrench, X, Download, MessageSquare, ChevronDown } from 'lucide-react';

// Sample data
const tickets = [
  { id: 'TKT-001', type: 'Maintenance', store: 'Tesco Express Manchester', engineer: 'John Smith', status: 'In Progress', priority: 'High', created: '2025-10-14', region: 'North West', location: { lat: 53.4808, lng: -2.2426 }, issues: 'Cigarette drawer sticking', progress: 60, dueDate: '2025-10-18' },
  { id: 'TKT-002', type: 'Installation', store: 'Sainsburys Birmingham', engineer: 'Sarah Jones', status: 'Pending', priority: 'Medium', created: '2025-10-15', region: 'Midlands', location: { lat: 52.4862, lng: -1.8904 }, issues: null, progress: 0, dueDate: '2025-10-20' },
  { id: 'TKT-003', type: 'Survey', store: 'Morrisons Leeds', engineer: 'Mike Wilson', status: 'Completed', priority: 'Low', created: '2025-10-10', region: 'Yorkshire', location: { lat: 53.8008, lng: -1.5491 }, issues: null, progress: 100, dueDate: '2025-10-12' },
  { id: 'TKT-004', type: 'Maintenance', store: 'Co-op Liverpool', engineer: 'Emma Brown', status: 'In Progress', priority: 'High', created: '2025-10-13', region: 'North West', location: { lat: 53.4084, lng: -2.9916 }, issues: 'Lock mechanism broken', progress: 40, dueDate: '2025-10-17' },
  { id: 'TKT-005', type: 'Installation', store: 'Asda London', engineer: 'Unassigned', status: 'Pending', priority: 'Medium', created: '2025-10-16', region: 'London', location: { lat: 51.5074, lng: -0.1278 }, issues: null, progress: 0, dueDate: '2025-10-22' },
  { id: 'TKT-006', type: 'Survey', store: 'Tesco Bristol', engineer: 'John Smith', status: 'Completed', priority: 'Low', created: '2025-10-08', region: 'South West', location: { lat: 51.4545, lng: -2.5879 }, issues: null, progress: 100, dueDate: '2025-10-09' },
];

const engineers = [
  { id: 1, name: 'John Smith', region: 'North West', activeJobs: 2 },
  { id: 2, name: 'Sarah Jones', region: 'Midlands', activeJobs: 1 },
  { id: 3, name: 'Mike Wilson', region: 'Yorkshire', activeJobs: 0 },
  { id: 4, name: 'Emma Brown', region: 'North West', activeJobs: 1 },
];

const sampleComments = [
  { id: 1, ticketId: 'TKT-001', author: 'John Smith', role: 'Engineer', text: 'Drawer mechanism needs full replacement. Ordered parts.', timestamp: '2025-10-14 14:30', avatar: 'JS' },
  { id: 2, ticketId: 'TKT-001', author: 'Office Admin', role: 'Admin', text: 'Parts approved. Please update when installed.', timestamp: '2025-10-14 15:45', avatar: 'OA' },
  { id: 3, ticketId: 'TKT-001', author: 'John Smith', role: 'Engineer', text: 'Parts received. Installation scheduled for tomorrow morning.', timestamp: '2025-10-15 09:15', avatar: 'JS' },
];

const notifications = [
  { id: 1, type: 'urgent', title: 'High Priority Job Overdue', message: 'TKT-004 at Co-op Liverpool is past due date', time: '5 min ago', ticketId: 'TKT-004' },
  { id: 2, type: 'warning', title: 'Engineer Needs Response', message: 'John Smith requested approval on TKT-001', time: '1 hour ago', ticketId: 'TKT-001' },
  { id: 3, type: 'info', title: 'Job Completed', message: 'TKT-003 survey completed by Mike Wilson', time: '2 hours ago', ticketId: 'TKT-003' },
];

// Image helper functions
function normaliseImageUrl(input) {
  if (!input) return '';
  const s = String(input).trim();
  const driveIdMatch = s.match(/drive\.google\.com\/file\/d\/([^/]+)/) || 
                       s.match(/[?&]id=([a-zA-Z0-9_-]{10,})/) || 
                       s.match(/(?:^|\b)([a-zA-Z0-9_-]{25,})$/);
  if (s.includes('drive.google.com') || driveIdMatch) {
    const id = driveIdMatch ? driveIdMatch[1] : s;
    return `https://drive.google.com/uc?export=view&id=${id}`;
  }
  return s;
}

function alternateImageUrls(url) {
  const list = [url];
  try {
    const u = new URL(url);
    if (u.hostname.includes('drive.google.com')) {
      const id = u.searchParams.get('id') || url.match(/file\/d\/([^/]+)/)?.[1];
      if (id) {
        list.push(`https://lh3.googleusercontent.com/d/${id}`);
        list.push(`https://drive.google.com/uc?export=download&id=${id}`);
      }
    }
  } catch {}
  return list;
}

// Smart Image Component with fallback URLs
function SmartImage({ src, label, onClick }) {
  const candidates = useMemo(() => alternateImageUrls(normaliseImageUrl(src)), [src]);
  const [index, setIndex] = useState(0);
  const active = candidates[Math.min(index, candidates.length - 1)];
  const [failed, setFailed] = useState(false);

  return (
    <div className="relative group">
      {!failed ? (
        <img 
          src={active} 
          alt={label || 'photo'} 
          loading="lazy"
          className="w-full aspect-square object-cover rounded-lg border-2 border-slate-300 hover:border-blue-500 transition cursor-pointer"
          onClick={onClick}
          onError={() => {
            if (index < candidates.length - 1) {
              setIndex(i => i + 1);
            } else {
              setFailed(true);
            }
          }}
        />
      ) : (
        <div className="aspect-square bg-gray-200 rounded-lg flex items-center justify-center border-2 border-slate-300">
          <div className="text-center text-gray-500 text-xs p-2">
            <Camera size={32} className="mx-auto mb-1 text-gray-400" />
            Image unavailable
          </div>
        </div>
      )}
      <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-2 rounded-b-lg opacity-0 group-hover:opacity-100 transition">
        {label}
      </div>
      <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
        <div className="bg-blue-600 text-white px-2 py-1 rounded text-xs">
          Click to enlarge
        </div>
      </div>
    </div>
  );
}

// Photo Gallery Component with upload/paste support
function PhotoGallery({ ticketId, initialPhotos = [], onEnlarge }) {
  const [imageStore, setImageStore] = useState(() => ({ [ticketId]: initialPhotos }));
  const photos = imageStore[ticketId] || [];

  function addLocalFiles(files) {
    const additions = Array.from(files).map(f => ({ 
      url: URL.createObjectURL(f), 
      label: f.name 
    }));
    setImageStore(prev => ({ 
      ...prev, 
      [ticketId]: [...(prev[ticketId] || []), ...additions] 
    }));
  }

  function handlePaste(e) {
    if (!e.clipboardData) return;
    const items = e.clipboardData.items;
    const blobs = [];
    
    for (const it of items) {
      if (it.kind === 'file') {
        blobs.push(it.getAsFile());
      }
      if (it.kind === 'string' && it.type === 'text/plain') {
        it.getAsString(txt => {
          const url = normaliseImageUrl(txt);
          setImageStore(prev => ({ 
            ...prev, 
            [ticketId]: [...(prev[ticketId] || []), { url, label: 'pasted' }] 
          }));
        });
      }
    }
    
    if (blobs.length) addLocalFiles(blobs);
  }

  return (
    <div className="space-y-3" onPaste={handlePaste}>
      <div className="flex items-center justify-between">
        <p className="text-sm text-gray-600 font-medium">Photos ({photos.length})</p>
        <div className="flex gap-2 items-center">
          <label className="px-3 py-1.5 text-sm border rounded-lg cursor-pointer inline-flex items-center gap-2 hover:bg-gray-50">
            <Camera size={16} /> Add files
            <input 
              type="file" 
              accept="image/*" 
              multiple 
              className="hidden" 
              onChange={e => e.target.files && addLocalFiles(e.target.files)} 
            />
          </label>
          <span className="text-xs text-gray-500">or paste images</span>
        </div>
      </div>

      {photos.length === 0 ? (
        <div className="aspect-video bg-gray-100 border border-dashed rounded-lg flex items-center justify-center text-gray-500">
          <div className="text-center">
            <Camera size={40} className="mx-auto mb-2 text-gray-400" />
            <p className="text-sm">No photos yet</p>
          </div>
        </div>
      ) : (
        <div className="grid grid-cols-2 gap-2">
          {photos.map((p, idx) => (
            <SmartImage 
              key={idx} 
              src={p.url} 
              label={p.label} 
              onClick={() => onEnlarge(p.url, p.label)} 
            />
          ))}
        </div>
      )}
    </div>
  );
}

function App() {
  const [currentView, setCurrentView] = useState('dashboard');
  const [selectedTicket, setSelectedTicket] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [enlargedImage, setEnlargedImage] = useState(null);
  const [showNotifications, setShowNotifications] = useState(false);
  const [filters, setFilters] = useState({
    status: '',
    priority: '',
    region: '',
    dateFrom: '',
    dateTo: '',
    type: ''
  });
  const [showFilters, setShowFilters] = useState(false);
  const [newComment, setNewComment] = useState('');

  // Your real GitHub-hosted images
  const demoImages = {
    image_1: 'https://raw.githubusercontent.com/Kaleid0trope/gantry-images/main/2b4f2805-f36a-4f93-91e0-2ff8a71f568d.jpg',
    image_2: 'https://raw.githubusercontent.com/Kaleid0trope/gantry-images/main/5bac1618-4d32-4b9f-aee6-7e2717d00191.jpg',
    image_3: 'https://raw.githubusercontent.com/Kaleid0trope/gantry-images/main/788555dd-d019-49f0-af17-33270fa2cb8e.jpg',
    image_4: 'https://raw.githubusercontent.com/Kaleid0trope/gantry-images/main/a7192acf-f6e3-4b91-807f-0f8aa041568b.jpg'
  };

  const initialTicketPhotos = useMemo(() => {
    const byType = (type) => {
      if (type === 'Survey') return [
        { url: demoImages.image_1, label: 'Gantry shelving - alcohol display' },
        { url: demoImages.image_4, label: 'Overall gantry condition' },
        { url: demoImages.image_2, label: 'Store interior layout' },
        { url: demoImages.image_3, label: 'Store exterior' },
      ];
      if (type === 'Maintenance') return [
        { url: demoImages.image_1, label: 'Before - Drawer issue' },
        { url: demoImages.image_4, label: 'After - Repaired drawer' },
        { url: demoImages.image_2, label: 'Parts replaced' },
        { url: demoImages.image_3, label: 'Final inspection' },
      ];
      if (type === 'Installation') return [
        { url: demoImages.image_3, label: 'Site preparation' },
        { url: demoImages.image_2, label: 'Installation in progress' },
        { url: demoImages.image_1, label: 'Completed installation' },
        { url: demoImages.image_4, label: 'Final setup' },
      ];
      return [];
    };
    const map = {};
    for (const t of tickets) map[t.id] = byType(t.type);
    return map;
  }, []);

  const getStatusColor = (status) => {
    switch(status) {
      case 'Completed': return 'bg-green-100 text-green-800';
      case 'In Progress': return 'bg-blue-100 text-blue-800';
      case 'Pending': return 'bg-yellow-100 text-yellow-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getPriorityColor = (priority) => {
    switch(priority) {
      case 'High': return 'text-red-600';
      case 'Medium': return 'text-orange-600';
      case 'Low': return 'text-green-600';
      default: return 'text-gray-600';
    }
  };

  const exportToPDF = () => {
    alert('PDF Export: In production, this would generate a PDF report of all tickets with photos and details.');
  };

  const exportToExcel = () => {
    alert('Excel Export: In production, this would generate an Excel spreadsheet with all ticket data.');
  };

  const getFilteredTickets = () => {
    return tickets.filter(ticket => {
      const matchesSearch = ticket.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
        ticket.store.toLowerCase().includes(searchTerm.toLowerCase()) ||
        ticket.engineer.toLowerCase().includes(searchTerm.toLowerCase());
      
      const matchesStatus = !filters.status || ticket.status === filters.status;
      const matchesPriority = !filters.priority || ticket.priority === filters.priority;
      const matchesRegion = !filters.region || ticket.region === filters.region;
      const matchesType = !filters.type || ticket.type === filters.type;
      const matchesDateFrom = !filters.dateFrom || ticket.created >= filters.dateFrom;
      const matchesDateTo = !filters.dateTo || ticket.created <= filters.dateTo;
      
      return matchesSearch && matchesStatus && matchesPriority && matchesRegion && 
             matchesType && matchesDateFrom && matchesDateTo;
    });
  };

  const clearFilters = () => {
    setFilters({
      status: '',
      priority: '',
      region: '',
      dateFrom: '',
      dateTo: '',
      type: ''
    });
  };

  const ImageModal = () => {
    if (!enlargedImage) return null;

    return (
      <div 
        className="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"
        onClick={() => setEnlargedImage(null)}
      >
        <button 
          className="absolute top-4 right-4 text-white hover:text-gray-300"
          onClick={() => setEnlargedImage(null)}
        >
          <X size={32} />
        </button>
        <div className="max-w-4xl max-h-full">
          <img 
            src={enlargedImage.url} 
            alt={enlargedImage.label}
            className="max-w-full max-h-screen object-contain"
          />
          <p className="text-white text-center mt-4 text-lg">{enlargedImage.label}</p>
        </div>
      </div>
    );
  };

  const NotificationsPanel = () => {
    if (!showNotifications) return null;

    return (
      <div className="fixed right-4 top-16 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 z-40 max-h-[600px] overflow-hidden">
        <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
          <h3 className="font-semibold text-lg text-gray-900">Notifications</h3>
          <button onClick={() => setShowNotifications(false)} className="text-gray-500 hover:text-gray-700">
            <X size={20} />
          </button>
        </div>
        <div className="divide-y divide-gray-100 overflow-y-auto max-h-[540px]">
          {notifications.map(notif => (
            <div 
              key={notif.id}
              className="p-4 hover:bg-gray-50 cursor-pointer transition"
              onClick={() => {
                const ticket = tickets.find(t => t.id === notif.ticketId);
                if (ticket) {
                  setSelectedTicket(ticket);
                  setCurrentView('detail');
                  setShowNotifications(false);
                }
              }}
            >
              <div className="flex items-start gap-3">
                <div className={`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${
                  notif.type === 'urgent' ? 'bg-red-500' :
                  notif.type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
                }`}></div>
                <div className="flex-1 min-w-0">
                  <p className="font-medium text-sm text-gray-900">{notif.title}</p>
                  <p className="text-sm text-gray-600 mt-1">{notif.message}</p>
                  <p className="text-xs text-gray-400 mt-2">{notif.time}</p>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  const Bell = ({ size = 20 }) => (
    <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
      <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </svg>
  );

  const Navigation = () => (
    <div className="bg-slate-900 text-white h-screen w-64 fixed left-0 top-0 p-4 shadow-xl">
      <div className="mb-8 pb-4 border-b border-slate-700">
        <h1 className="text-xl font-bold tracking-tight">Gantry Manager</h1>
        <p className="text-sm text-slate-400 mt-1">Order Processing System</p>
      </div>
      
      <nav className="space-y-1">
        <button
          onClick={() => setCurrentView('dashboard')}
          className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition font-medium ${
            currentView === 'dashboard' ? 'bg-slate-700 text-white' : 'text-slate-300 hover:bg-slate-800 hover:text-white'
          }`}
        >
          <Home size={20} />
          <span>Dashboard</span>
        </button>
        
        <button
          onClick={() => setCurrentView('map')}
          className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition font-medium ${
            currentView === 'map' ? 'bg-slate-700 text-white' : 'text-slate-300 hover:bg-slate-800 hover:text-white'
          }`}
        >
          <MapPin size={20} />
          <span>Map View</span>
        </button>
        
        <button
          onClick={() => setCurrentView('list')}
          className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition font-medium ${
            currentView === 'list' ? 'bg-slate-700 text-white' : 'text-slate-300 hover:bg-slate-800 hover:text-white'
          }`}
        >
          <List size={20} />
          <span>All Tickets</span>
        </button>
        
        <div className="pt-4">
          <button
            onClick={() => setCurrentView('create')}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition bg-blue-600 hover:bg-blue-700 font-medium ${
              currentView === 'create' ? 'bg-blue-700' : ''
            }`}
          >
            <Plus size={20} />
            <span>Create Ticket</span>
          </button>
        </div>
      </nav>

      <div className="absolute bottom-4 left-4 right-4 space-y-3">
        <button 
          onClick={() => setShowNotifications(!showNotifications)}
          className="w-full flex items-center gap-3 px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg transition relative font-medium"
        >
          <Bell size={20} />
          <span>Notifications</span>
          {notifications.filter(n => n.type === 'urgent').length > 0 && (
            <span className="absolute top-2 right-2 w-5 h-5 bg-red-500 text-xs flex items-center justify-center rounded-full font-semibold">
              {notifications.filter(n => n.type === 'urgent').length}
            </span>
          )}
        </button>
        
        <div className="bg-slate-800 rounded-lg p-3 border border-slate-700">
          <p className="text-xs text-slate-400 uppercase tracking-wide">Logged in as</p>
          <p className="text-sm font-medium mt-1">Office Administrator</p>
        </div>
      </div>
    </div>
  );

  const DashboardView = () => {
    const stats = {
      total: tickets.length,
      pending: tickets.filter(t => t.status === 'Pending').length,
      inProgress: tickets.filter(t => t.status === 'In Progress').length,
      completed: tickets.filter(t => t.status === 'Completed').length,
    };

    const urgentTickets = tickets.filter(t => t.priority === 'High' && t.status !== 'Completed');

    return (
      <div className="space-y-6">
        <div>
          <h2 className="text-3xl font-bold text-gray-900">Dashboard</h2>
          <p className="text-gray-600 mt-1">Overview of all gantry maintenance operations</p>
        </div>
        
        {urgentTickets.length > 0 && (
          <div className="bg-red-50 border border-red-200 p-4 rounded-lg">
            <div className="flex items-start gap-3">
              <AlertCircle size={24} className="text-red-600 mt-0.5 flex-shrink-0" />
              <div className="flex-1">
                <h3 className="font-semibold text-red-900">High Priority Jobs Require Attention</h3>
                <p className="text-red-700 text-sm mt-1">
                  {urgentTickets.length} high priority {urgentTickets.length === 1 ? 'job requires' : 'jobs require'} immediate action
                </p>
                <div className="mt-3 space-y-1">
                  {urgentTickets.slice(0, 3).map(ticket => (
                    <button
                      key={ticket.id}
                      onClick={() => {
                        setSelectedTicket(ticket);
                        setCurrentView('detail');
                      }}
                      className="text-sm text-red-800 hover:text-red-900 font-medium underline block"
                    >
                      {ticket.id} - {ticket.store}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}
        
        <div className="grid grid-cols-4 gap-4">
          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 uppercase tracking-wide">Total Tickets</p>
                <p className="text-3xl font-bold text-gray-900 mt-2">{stats.total}</p>
              </div>
              <Package size={40} className="text-blue-600" />
            </div>
          </div>
          
          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 uppercase tracking-wide">Pending</p>
                <p className="text-3xl font-bold text-gray-900 mt-2">{stats.pending}</p>
              </div>
              <Clock size={40} className="text-yellow-600" />
            </div>
          </div>
          
          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 uppercase tracking-wide">In Progress</p>
                <p className="text-3xl font-bold text-gray-900 mt-2">{stats.inProgress}</p>
              </div>
              <Wrench size={40} className="text-blue-600" />
            </div>
          </div>
          
          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600 uppercase tracking-wide">Completed</p>
                <p className="text-3xl font-bold text-gray-900 mt-2">{stats.completed}</p>
              </div>
              <CheckCircle size={40} className="text-green-600" />
            </div>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-6">
          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h3>
            <div className="space-y-3">
              {tickets.slice(0, 4).map(ticket => (
                <div key={ticket.id} className="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                  <div>
                    <p className="font-medium text-gray-900">{ticket.id}</p>
                    <p className="text-sm text-gray-600">{ticket.store}</p>
                  </div>
                  <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(ticket.status)}`}>
                    {ticket.status}
                  </span>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">Engineer Status</h3>
            <div className="space-y-3">
              {engineers.map(eng => (
                <div key={eng.id} className="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                  <div>
                    <p className="font-medium text-gray-900">{eng.name}</p>
                    <p className="text-sm text-gray-600">{eng.region}</p>
                  </div>
                  <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold">
                    {eng.activeJobs} Active
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const MapView = () => (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">National Map View</h2>
      
      <div className="bg-white rounded-lg shadow overflow-hidden" style={{ height: '600px' }}>
        <div className="relative w-full h-full bg-slate-100">
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="text-center">
              <MapPin size={48} className="text-slate-400 mx-auto mb-4" />
              <p className="text-slate-600">Map visualization would display here</p>
              <p className="text-sm text-slate-500 mt-2">Shows all store locations with color-coded status pins</p>
            </div>
          </div>
          
          {tickets.map((ticket, i) => (
            <div
              key={ticket.id}
              className="absolute cursor-pointer"
              style={{
                left: `${20 + i * 15}%`,
                top: `${30 + (i % 2) * 20}%`
              }}
              onClick={() => {
                setSelectedTicket(ticket);
                setCurrentView('detail');
              }}
            >
              <div className={`w-8 h-8 rounded-full flex items-center justify-center shadow-lg ${
                ticket.status === 'Completed' ? 'bg-green-500' :
                ticket.status === 'In Progress' ? 'bg-blue-500' : 'bg-yellow-500'
              }`}>
                <MapPin size={20} className="text-white" />
              </div>
              <div className="bg-white px-2 py-1 rounded shadow-lg text-xs mt-1 whitespace-nowrap">
                {ticket.store.split(' ')[0]}
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div className="bg-white p-4 rounded-lg shadow flex items-center gap-3">
          <div className="w-4 h-4 rounded-full bg-green-500"></div>
          <span className="text-sm">Completed</span>
        </div>
        <div className="bg-white p-4 rounded-lg shadow flex items-center gap-3">
          <div className="w-4 h-4 rounded-full bg-blue-500"></div>
          <span className="text-sm">In Progress</span>
        </div>
        <div className="bg-white p-4 rounded-lg shadow flex items-center gap-3">
          <div className="w-4 h-4 rounded-full bg-yellow-500"></div>
          <span className="text-sm">Pending</span>
        </div>
      </div>
    </div>
  );

  const ListView = () => {
    const filteredTickets = getFilteredTickets();

    return (
      <div className="space-y-6">
        <div className="flex justify-between items-center">
          <div>
            <h2 className="text-3xl font-bold text-gray-900">All Tickets</h2>
            <p className="text-gray-600 mt-1">Complete list of maintenance operations</p>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={exportToPDF}
              className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium shadow-sm"
            >
              <Download size={20} />
              Export PDF
            </button>
            <button 
              onClick={exportToExcel}
              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium shadow-sm"
            >
              <Download size={20} />
              Export Excel
            </button>
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
          <div className="flex gap-2 mb-4">
            <div className="relative flex-1">
              <Search size={20} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
              <input
                type="text"
                placeholder="Search by ticket ID, store, or engineer..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <button 
              onClick={() => setShowFilters(!showFilters)}
              className={`flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium ${showFilters ? 'bg-gray-100' : ''}`}
            >
              <Filter size={20} />
              Filters
              <ChevronDown size={16} className={`transition-transform ${showFilters ? 'rotate-180' : ''}`} />
            </button>
          </div>

          {showFilters && (
            <div className="border-t border-gray-200 pt-4">
              <div className="grid grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Status</label>
                  <select 
                    value={filters.status}
                    onChange={(e) => setFilters({...filters, status: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">All Statuses</option>
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                  <select 
                    value={filters.priority}
                    onChange={(e) => setFilters({...filters, priority: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">All Priorities</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Job Type</label>
                  <select 
                    value={filters.type}
                    onChange={(e) => setFilters({...filters, type: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">All Types</option>
                    <option value="Survey">Survey</option>
                    <option value="Installation">Installation</option>
                    <option value="Maintenance">Maintenance</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Region</label>
                  <select 
                    value={filters.region}
                    onChange={(e) => setFilters({...filters, region: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">All Regions</option>
                    <option value="North West">North West</option>
                    <option value="Midlands">Midlands</option>
                    <option value="Yorkshire">Yorkshire</option>
                    <option value="London">London</option>
                    <option value="South West">South West</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                  <input 
                    type="date"
                    value={filters.dateFrom}
                    onChange={(e) => setFilters({...filters, dateFrom: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                  <input 
                    type="date"
                    value={filters.dateTo}
                    onChange={(e) => setFilters({...filters, dateTo: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>

              <div className="flex gap-2 mt-4">
                <button 
                  onClick={clearFilters}
                  className="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 font-medium"
                >
                  Clear Filters
                </button>
                <span className="text-sm text-gray-600 py-2 font-medium">
                  Showing {filteredTickets.length} of {tickets.length} tickets
                </span>
              </div>
            </div>
          )}
        </div>

        <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <table className="w-full">
            <thead className="bg-gray-50 border-b border-gray-200">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ticket ID</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Type</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Store</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Region</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Engineer</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Priority</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Created</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 bg-white">
              {filteredTickets.map(ticket => (
                <tr key={ticket.id} className="hover:bg-gray-50 transition">
                  <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{ticket.id}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-gray-700">{ticket.type}</td>
                  <td className="px-6 py-4 text-gray-700">{ticket.store}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-gray-700">{ticket.region}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-gray-700">{ticket.engineer}</td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${getStatusColor(ticket.status)}`}>
                      {ticket.status}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`font-semibold ${getPriorityColor(ticket.priority)}`}>
                      {ticket.priority}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{ticket.created}</td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <button
                      onClick={() => {
                        setSelectedTicket(ticket);
                        setCurrentView('detail');
                      }}
                      className="text-blue-600 hover:text-blue-800 font-semibold text-sm"
                    >
                      View Details
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  const DetailView = () => {
    if (!selectedTicket) return null;
    const seed = initialTicketPhotos[selectedTicket.id] || [];

    return (
      <div className="space-y-6">
        <button
          onClick={() => setCurrentView('list')}
          className="flex items-center gap-2 text-blue-600 hover:text-blue-800"
        >
          <ArrowLeft size={20} />
          Back to List
        </button>

        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex justify-between items-start mb-6">
            <div>
              <h2 className="text-3xl font-bold">{selectedTicket.id}</h2>
              <p className="text-gray-600 mt-1">{selectedTicket.type}</p>
            </div>
            <span className={`px-4 py-2 rounded-full text-sm font-medium ${getStatusColor(selectedTicket.status)}`}>
              {selectedTicket.status}
            </span>
          </div>

          <div className="grid grid-cols-2 gap-6 mb-6">
            <div>
              <p className="text-sm text-gray-600">Store Location</p>
              <p className="font-medium text-lg">{selectedTicket.store}</p>
            </div>
            <div>
              <p className="text-sm text-gray-600">Assigned Engineer</p>
              <p className="font-medium text-lg">{selectedTicket.engineer}</p>
            </div>
            <div>
              <p className="text-sm text-gray-600">Priority</p>
              <p className={`font-medium text-lg ${getPriorityColor(selectedTicket.priority)}`}>
                {selectedTicket.priority}
              </p>
            </div>
            <div>
              <p className="text-sm text-gray-600">Created Date</p>
              <p className="font-medium text-lg">{selectedTicket.created}</p>
            </div>
          </div>

          {selectedTicket.issues && (
            <div className="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded">
              <div className="flex items-start gap-2">
                <AlertCircle size={20} className="text-red-600 mt-0.5" />
                <div>
                  <p className="font-medium text-red-900">Reported Issues</p>
                  <p className="text-red-700">{selectedTicket.issues}</p>
                </div>
              </div>
            </div>
          )}

          <div className="mb-6">
            <p className="text-sm text-gray-600 mb-2">Progress</p>
            <div className="w-full bg-gray-200 rounded-full h-4">
              <div
                className="bg-blue-600 h-4 rounded-full transition-all"
                style={{ width: `${selectedTicket.progress}%` }}
              ></div>
            </div>
            <p className="text-sm text-gray-600 mt-1">{selectedTicket.progress}% Complete</p>
          </div>

          <div className="grid grid-cols-2 gap-6">
            <div>
              <h3 className="font-semibold mb-3 flex items-center gap-2">
                <CheckCircle size={20} />
                Checklist
              </h3>
              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <input type="checkbox" checked readOnly className="w-4 h-4" />
                  <span className="text-sm">Initial inspection completed</span>
                </div>
                <div className="flex items-center gap-2">
                  <input type="checkbox" checked={selectedTicket.progress > 50} readOnly className="w-4 h-4" />
                  <span className="text-sm">Parts ordered/installed</span>
                </div>
                <div className="flex items-center gap-2">
                  <input type="checkbox" checked={selectedTicket.progress === 100} readOnly className="w-4 h-4" />
                  <span className="text-sm">Final testing</span>
                </div>
                <div className="flex items-center gap-2">
                  <input type="checkbox" checked={selectedTicket.progress === 100} readOnly className="w-4 h-4" />
                  <span className="text-sm">Documentation completed</span>
                </div>
              </div>
            </div>

            <div>
              <h3 className="font-semibold mb-3 flex items-center gap-2">
                <Camera size={20} />
                Site Photos
              </h3>
              <PhotoGallery 
                ticketId={selectedTicket.id} 
                initialPhotos={seed} 
                onEnlarge={(url, label) => setEnlargedImage({ url, label })} 
              />
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="font-semibold mb-3 flex items-center gap-2">
            <FileText size={20} />
            Work Log
          </h3>
          <div className="space-y-3">
            <div className="border-l-2 border-blue-500 pl-4 py-2">
              <p className="text-sm text-gray-600">2025-10-16 09:15</p>
              <p className="font-medium">Job started</p>
              <p className="text-sm text-gray-700">Engineer arrived on site and began initial assessment.</p>
            </div>
            {selectedTicket.progress > 0 && (
              <div className="border-l-2 border-blue-500 pl-4 py-2">
                <p className="text-sm text-gray-600">2025-10-16 10:30</p>
                <p className="font-medium">Progress update</p>
                <p className="text-sm text-gray-700">Identified issue with drawer mechanism. Ordering replacement parts.</p>
              </div>
            )}
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="font-semibold mb-4 flex items-center gap-2">
            <MessageSquare size={20} />
            Comments & Notes ({sampleComments.filter(c => c.ticketId === selectedTicket.id).length})
          </h3>
          
          <div className="space-y-4 mb-4">
            {sampleComments
              .filter(comment => comment.ticketId === selectedTicket.id)
              .map(comment => (
                <div key={comment.id} className="flex gap-3 pb-4 border-b last:border-b-0">
                  <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold text-sm flex-shrink-0">
                    {comment.avatar}
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="font-medium">{comment.author}</span>
                      <span className="text-xs px-2 py-0.5 bg-gray-100 rounded-full">{comment.role}</span>
                      <span className="text-xs text-gray-500">{comment.timestamp}</span>
                    </div>
                    <p className="text-sm text-gray-700">{comment.text}</p>
                  </div>
                </div>
              ))}
            
            {sampleComments.filter(c => c.ticketId === selectedTicket.id).length === 0 && (
              <p className="text-gray-500 text-sm italic">No comments yet. Be the first to add a note.</p>
            )}
          </div>

          <div className="border-t pt-4">
            <textarea
              value={newComment}
              onChange={(e) => setNewComment(e.target.value)}
              placeholder="Add a comment or note..."
              className="w-full px-4 py-2 border rounded-lg mb-2 resize-none"
              rows={3}
            />
            <div className="flex justify-end">
              <button 
                onClick={() => {
                  if (newComment.trim()) {
                    alert(`Comment added: "${newComment}"`);
                    setNewComment('');
                  }
                }}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled={!newComment.trim()}
              >
                Add Comment
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const CreateView = () => (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Create New Ticket</h2>
      
      <div className="bg-white rounded-lg shadow p-6">
        <div className="space-y-6">
          <div className="grid grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Job Type
              </label>
              <select className="w-full px-4 py-2 border rounded-lg">
                <option>Maintenance</option>
                <option>Installation</option>
                <option>Survey</option>
              </select>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Priority
              </label>
              <select className="w-full px-4 py-2 border rounded-lg">
                <option>High</option>
                <option>Medium</option>
                <option>Low</option>
              </select>
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Store Location
            </label>
            <input
              type="text"
              placeholder="Enter store name or address"
              className="w-full px-4 py-2 border rounded-lg"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Assign Engineer
            </label>
            <select className="w-full px-4 py-2 border rounded-lg">
              <option value="">Select engineer...</option>
              {engineers.map(eng => (
                <option key={eng.id} value={eng.id}>
                  {eng.name} - {eng.region} ({eng.activeJobs} active jobs)
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Description
            </label>
            <textarea
              rows={4}
              placeholder="Describe the work required..."
              className="w-full px-4 py-2 border rounded-lg"
            ></textarea>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Scheduled Date
            </label>
            <input
              type="date"
              className="w-full px-4 py-2 border rounded-lg"
            />
          </div>

          <div className="flex gap-4 pt-4">
            <button
              onClick={() => alert('Ticket created!')}
              className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
            >
              Create Ticket
            </button>
            <button
              onClick={() => setCurrentView('dashboard')}
              className="px-6 py-3 border rounded-lg hover:bg-gray-50 font-medium"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="bg-gray-100 min-h-screen">
      <Navigation />
      <NotificationsPanel />
      <ImageModal />
      
      <div className="ml-64 p-8">
        {currentView === 'dashboard' && <DashboardView />}
        {currentView === 'map' && <MapView />}
        {currentView === 'list' && <ListView />}
        {currentView === 'detail' && <DetailView />}
        {currentView === 'create' && <CreateView />}
      </div>
    </div>
  );
}

export default App;
